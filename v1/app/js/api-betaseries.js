"use strict";!function(){function e(e){this.db=e,this.user={},this.episodesUnseen={},this.filmsUnseen={}}function n(e,n,o,i,r){var u=JSON.stringify(o),c="api.betaseries.com",a={Accept:"application/json","X-BetaSeries-Version":2.4,"X-BetaSeries-Key":"b931e8e98023"};e+="?"+s.stringify(o),"GET"!=n&&(a["Content-Type"]="application/json",a["Content-Length"]=u.length);var p={host:c,path:e,method:n,headers:a},d=t.request(p,function(e){e.setEncoding("utf-8");var n="";e.on("data",function(e){n+=e}),e.on("end",function(){var e=JSON.parse(n);i(e)})});d.on("error",function(e){r&&r()}),d.write(u),d.end()}var s=(require("fs"),require("querystring")),t=require("https"),o=require("crypto-js/md5"),i=require("underscore");e.prototype.connectToApi=function(e){var s=this;utils.getParam(s.db,"BTaccess",function(t){n("/members/auth","POST",{login:t.login,password:o(t.password).toString()},function(n){0==n.errors.length&&(s.user.hash=n.hash,s.user.token=n.token,s.user.user=n.user),(e||Function)()})},!0)},e.prototype.disconnectToApi=function(e){var s=this;n("/members/destroy","POST",{},function(n){delete s.user.hash,delete s.user.token,delete s.user.user,(e||Function)()},e||Function)},e.prototype.saveAccess=function(e,n,s){var t=this;utils.setParam(t.db,"BTaccess",{login:e,password:n},s,!0)},e.prototype.synchroEpisodesUnseen=function(e){var s=this;n("/episodes/list","GET",{token:s.user.token},function(n){0==n.errors.length?(delete s.episodesUnseen.shows,s.episodesUnseen.shows=n.shows,(e||Function)(!0)):(e||Function)(!1)})},e.prototype.synchroFilmUnseen=function(){var e=this;return new Promise(function(s,t){n("/movies/member","GET",{token:e.user.token},function(n){0==n.errors.length?(delete e.filmsUnseen.movies,e.filmsUnseen.movies=i.chain(n.movies).each(function(e){e.group_by_date=e.release_date.substring(0,7)}).sortBy("group_by_date").reverse().groupBy("group_by_date").value(),s()):t()},function(e){t()})})},e.prototype.seenEpisode=function(e,s){var t=this;n("/episodes/watched","POST",{id:e.id,token:t.user.token},s||Function)},e.prototype.unseenEpisode=function(e,s){var t=this;n("/episodes/watched","DELETE",{id:e.id,token:t.user.token},s||Function)},exports.apiBetaseries=e}();